THREE.MirrorRenderer=function(t,e,r,i){function a(t,e){return void 0!==t?t:e}THREE.Object3D.call(this),this.name="mirror_"+this.id,i=i||{},this.matrixNeedsUpdate=!0;var s=a(i.textureWidth,512),o=a(i.textureHeight,512);this.clipBias=a(i.clipBias,0),this.renderer=t,this.scene=r,this.mirrorPlane=new THREE.Plane,this.normal=new THREE.Vector3(0,0,1),this.cameraWorldPosition=new THREE.Vector3,this.rotationMatrix=new THREE.Matrix4,this.lookAtPosition=new THREE.Vector3(0,0,-1),this.clipPlane=new THREE.Vector4,e instanceof THREE.PerspectiveCamera?this.camera=e:(this.camera=new THREE.PerspectiveCamera,console.log(this.name+": camera is not a Perspective Camera!")),this.textureMatrix=new THREE.Matrix4,this.mirrorCamera=this.camera.clone(),this.mesh=new THREE.Object3D,this.texture=new THREE.WebGLRenderTarget(s,o),this.tempTexture=new THREE.WebGLRenderTarget(s,o),THREE.Math.isPowerOfTwo(s)&&THREE.Math.isPowerOfTwo(o)||(this.texture.generateMipmaps=!1,this.tempTexture.generateMipmaps=!1),this.updateTextureMatrix(),this.render()},THREE.MirrorRenderer.prototype=Object.create(THREE.Object3D.prototype),THREE.MirrorRenderer.prototype.renderWithMirror=function(t){this.updateTextureMatrix(),this.matrixNeedsUpdate=!1;var e=t.camera;t.camera=this.mirrorCamera,t.render(!0),t.material.uniforms.mirrorSampler.value=t.tempTexture,this.render(),this.matrixNeedsUpdate=!0,t.material.uniforms.mirrorSampler.value=t.texture,t.camera=e,t.updateTextureMatrix()},THREE.MirrorRenderer.prototype.updateTextureMatrix=function(){void 0!=this.parent&&(this.mesh=this.parent),this.updateMatrixWorld(),this.camera.updateMatrixWorld(),this.cameraWorldPosition.setFromMatrixPosition(this.camera.matrixWorld),this.rotationMatrix.extractRotation(this.matrixWorld),this.normal=new THREE.Vector3(0,1,0).applyEuler(this.mesh.rotation);var t,e,r=new THREE.Vector3(0,0,1).applyEuler(this.camera.rotation);if(0>this.normal.dot(r)){var i=new THREE.Vector3(0,0,1).applyEuler(this.mesh.rotation);this.normal.reflect(i)}var a=this.mesh.position.clone().sub(this.cameraWorldPosition);a.reflect(this.normal).negate(),a.add(this.mesh.position),this.rotationMatrix.extractRotation(this.camera.matrixWorld),this.lookAtPosition.set(0,0,-1),this.lookAtPosition.applyMatrix4(this.rotationMatrix),this.lookAtPosition.add(this.cameraWorldPosition);var s=this.mesh.position.clone().sub(this.lookAtPosition);s.reflect(this.normal).negate(),s.add(this.mesh.position),this.up.set(0,-1,0),this.up.applyMatrix4(this.rotationMatrix),this.up.reflect(this.normal).negate(),this.mirrorCamera.position.copy(a),this.mirrorCamera.up=this.up,this.mirrorCamera.lookAt(s),this.mirrorCamera.aspect=this.camera.aspect,this.mirrorCamera.updateProjectionMatrix(),this.mirrorCamera.updateMatrixWorld(),this.mirrorCamera.matrixWorldInverse.getInverse(this.mirrorCamera.matrixWorld),this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.mirrorCamera.projectionMatrix),this.textureMatrix.multiply(this.mirrorCamera.matrixWorldInverse),this.mirrorPlane.setFromNormalAndCoplanarPoint(this.normal,this.mesh.position),this.mirrorPlane.applyMatrix4(this.mirrorCamera.matrixWorldInverse),this.clipPlane.set(this.mirrorPlane.normal.x,this.mirrorPlane.normal.y,this.mirrorPlane.normal.z,this.mirrorPlane.constant);var o=new THREE.Vector4,n=this.mirrorCamera.projectionMatrix;o.x=(((t=this.clipPlane.x)?t<0?-1:1:0)+n.elements[8])/n.elements[0],o.y=(((e=this.clipPlane.y)?e<0?-1:1:0)+n.elements[9])/n.elements[5],o.z=-1,o.w=(1+n.elements[10])/n.elements[14];var m=new THREE.Vector4;m=this.clipPlane.multiplyScalar(2/this.clipPlane.dot(o)),n.elements[2]=m.x,n.elements[6]=m.y,n.elements[10]=m.z+1-this.clipBias,n.elements[14]=m.w;var h=new THREE.Vector3;h.setFromMatrixPosition(this.camera.matrixWorld),this.eye=h},THREE.MirrorRenderer.prototype.render=function(t){if(this.matrixNeedsUpdate&&this.updateTextureMatrix(),this.matrixNeedsUpdate=!0,void 0!==this.scene&&this.scene instanceof THREE.Scene){var e=void 0!==t&&t?this.tempTexture:this.texture;this.renderer.render(this.scene,this.mirrorCamera,e,!0)}};
//# sourceMappingURL=index.8aced1e0.js.map
